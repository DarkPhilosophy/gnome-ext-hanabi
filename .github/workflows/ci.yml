name: Extension CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Validate & Lint
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: Install dependencies
      run: npm install

    - name: Lint JavaScript
      run: npm run lint

    - name: Update Lint Status in README
      if: always()
      run: npm run lint:status

    - name: Validate Schemas
      run: glib-compile-schemas --strict --dry-run extension/schemas/

    - name: Validate Metadata Template
      run: |
        node -e "
          const fs = require('fs');
          const content = fs.readFileSync('extension/metadata.json.in', 'utf8')
            .replace(/@uuid@/g, 'hanabi-extension@jeffshee.github.io')
            .replace(/@settings_schema@/g, 'io.github.jeffshee.hanabi-extension')
            .replace(/@version@/g, '1');

          const meta = JSON.parse(content);
          const required = ['name', 'description', 'uuid', 'shell-version'];
          for (const field of required) {
            if (!meta[field]) {
              console.error(`Error: Missing required field '${field}'`);
              process.exit(1);
            }
          }
          console.log('Metadata template looks good! âœ…');
        "

  package:
    name: Build Package
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: Install dependencies
      run: npm install

    - name: Fetch GNOME Extensions Version
      run: node scripts/fetch-ego-version.js
      env:
        EGO_EXTENSION_ID: ${{ secrets.EGO_EXTENSION_ID }}

    - name: Build Extension Package
      run: ./package.sh

    - name: Commit Updated Results
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        if [[ -n $(git status --porcelain .github/README.md) ]]; then
          git add .github/README.md
          git commit -m "Docs: Update version badges and CI linting results [skip ci]"
          git push
        else
          echo "No changes to README.md"
        fi

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: extension-package
        path: hanabi-extension@jeffshee.github.io.zip
